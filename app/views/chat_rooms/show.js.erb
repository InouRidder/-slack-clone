function scrollToLastMessage() {
  const messages = document.getElementById('messages');
  if (messages.children.length === 0 ) {return};
  messages.children[messages.children.length - 1].scrollIntoView();
}

function setChatRoom() {
  const chatRoom = document.getElementById('chat-room');
  chatRoom.innerHTML = "<%= j render 'chat_rooms/chat_room', chat_room: @chat_room, message: @message %>";
  scrollToLastMessage();
}

App.active_room_id = <%= @chat_room.id %>;
App['chat_room_<%= @chat_room.id %>'] = App.cable.subscriptions.create(
    { channel: 'ChatRoomsChannel', chat_room_id: <%= @chat_room.id %> },
    { received: (data) => {
      if (data.current_user_id !== <%= current_user.id %>) {
        const messages = document.getElementById('messages')
        messages.insertAdjacentHTML("beforeend", data.message_partial)
        messages.children[messages.children.length -1].scrollIntoView();
      }
    }
  }
)


function appendChat(){
  const chatList = document.getElementById('chat-list');
  chatList.insertAdjacentHTML('beforeend', "<%= j render 'chat_room_links', chat_room: @chat_room %>");
}

function eventFire(el, etype){
  if (el.fireEvent) {
    el.fireEvent('on' + etype);
  } else {
    const evObj = document.createEvent('Events');
    evObj.initEvent(etype, true, false);
    el.dispatchEvent(evObj);
  }
}

function removeModal() {
  const modals = document.querySelectorAll('.modal');
  modals.forEach(modal => {
    eventFire(modal, 'click');
  })
}

function removeNotifications() {
  const notifications = document.querySelector("[data-chat-id='<%= @chat_room.id %>']").querySelector('.notifications')
  notifications.innerText = "";
  // notifications.style.classList.remove('red-circle');
}

<% if @after_create %>
  setChatRoom();
  appendChat()
<% end %>

setChatRoom();
removeModal();
removeNotifications();
